@page "/"
@inject IDbContextFactory<Contexto> DbContextFactory
@inject KeyStore.Services.ICartService CartService
@inject IJSRuntime JSRuntime
@using Microsoft.EntityFrameworkCore
@using KeyStore.DAL
@using KeyStore.Models
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using KeyStore.Data
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager

<div class="home-container">
    <section class="hero-section">
        <div class="hero-content">
            <div class="hero-text">
                <h1 class="brand-title">KEYSTORE</h1>
                <div class="brand-subtitle">Experiencia Premium</div>
                <div class="hero-buttons">
                    <button class="btn btn-primary">Comprar Ahora</button>
                    <a href="/Shop" class="btn btn-secondary">Explorar</a>
                </div>
            </div>
            <div class="hero-image">

                <div id="heroCarousel" class="carousel slide hero-carousel" data-bs-ride="carousel" data-bs-interval="5000">
                    @if (productosCarousel != null && productosCarousel.Any())
                    {
                        <div class="carousel-inner">
                            @for (int i = 0; i < productosCarousel.Count; i++)
                            {
                                var producto = productosCarousel[i];
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <div class="hero-carousel-card">
                                        @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                                        {
                                            <img src="@producto.ImagenUrl"
                                                 class="hero-carousel-image"
                                                 alt="@producto.Nombre">
                                        }
                                        else
                                        {
                                            <div class="hero-carousel-placeholder">
                                                <i class="bi bi-image"></i>
                                                <span>Sin imagen</span>
                                            </div>
                                        }

                                        <div class="hero-carousel-overlay">
                                            <div class="hero-carousel-info">
                                                <h3 class="hero-carousel-title">@producto.Nombre</h3>
                                                <p class="hero-carousel-price">$@producto.Precio.ToString("F2")</p>
                                                @if (!string.IsNullOrEmpty(producto.Marca))
                                                {
                                                    <p class="hero-carousel-brand">@producto.Marca</p>
                                                }
                                                <button class="btn btn-primary hero-carousel-btn"
                                                        @onclick="() => AgregarAlCarrito(producto.Id)"
                                                        disabled="@procesandoCarrito">
                                                    <i class="bi bi-cart-plus"></i> Agregar al Carrito
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>


                        <div class="carousel-indicators hero-carousel-indicators">
                            @for (int i = 0; i < productosCarousel.Count; i++)
                            {
                                <button type="button"
                                        data-bs-target="#heroCarousel"
                                        data-bs-slide-to="@i"
                                        class="@(i == 0 ? "active" : "")"
                                        aria-current="@(i == 0 ? "true" : "false")"
                                        aria-label="Slide @(i + 1)">
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="carousel-inner">
                            <div class="carousel-item active">
                                <div class="hero-empty-carousel">
                                    <div class="empty-carousel-content">
                                        <i class="bi bi-box-seam display-1 text-muted mb-3"></i>
                                        <h4 class="text-white">No hay productos para mostrar</h4>
                                        <p class="text-muted">Agrega algunos productos para que aparezcan en el carousel</p>
                                        <AuthorizeView Roles="Admin">
                                            <Authorized>
                                                <a href="/Productos/Crear" class="btn btn-primary">
                                                    <i class="bi bi-plus-circle"></i> Crear Producto
                                                </a>
                                            </Authorized>
                                        </AuthorizeView>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="hero-glow"></div>
            </div>
        </div>
    </section>

    <section class="categories-section">
        <h2 class="section-title">Productos</h2>


        <div style="color: white; text-align: center; margin-bottom: 20px;">
            <small>Debug: @(productos?.Count ?? 0) productos cargados</small>
        </div>

        <div class="categories-grid">
            @if (productos != null && productos.Any())
            {
                foreach (var producto in productos)
                {
                    <div class="category-card">
                        <div class="category-image">
                            @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                            {
                                <img src="@producto.ImagenUrl" alt="@producto.Nombre" class="img-fluid" />
                            }
                            else
                            {
                                <span class="image-ref">[Sin imagen]</span>
                            }
                            <div class="category-overlay">
                                <button class="add-btn-new" @onclick="() => AgregarAlCarrito(producto.Id)" disabled="@procesandoCarrito">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="category-info">
                            <p class="category-title">@producto.Nombre</p>
                            <div class="category-price">$@producto.Precio.ToString("F2")</div>
                            @if (!string.IsNullOrEmpty(producto.Marca))
                            {
                                <small class="category-brand">@producto.Marca</small>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-box-seam"></i>
                    <h4>No hay productos aún</h4>
                    <p>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <a href="/Productos/Crear" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> Crear tu primer producto
                                </a>
                            </Authorized>
                            <NotAuthorized>
                                <span>Próximamente tendremos productos disponibles</span>
                            </NotAuthorized>
                        </AuthorizeView>
                    </p>
                </div>
            }
        </div>
    </section>

    <section class="featured-section">
        <h2 class="section-title">Productos Destacados</h2>
        <p class="featured-subtitle">Eleva tu experiencia con nuestros productos más populares</p>

        @* Debug info - Remover después de solucionar *@
        <div style="color: white; text-align: center; margin-bottom: 20px;">
            <small>Debug: @(productosDestacados?.Count ?? 0) productos destacados cargados</small>
        </div>

        <div class="products-grid">
            @if (productosDestacados != null && productosDestacados.Any())
            {
                foreach (var producto in productosDestacados.Take(3))
                {
                    <div class="product-card">
                        <div class="product-image">
                            @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                            {
                                <img src="@producto.ImagenUrl"
                                     alt="@producto.Nombre"
                                     class="img-fluid"
                                     style="object-fit: cover;" />
                            }
                            else
                            {
                                <span class="image-ref">[IMAGEN: @producto.Nombre]</span>
                            }
                            <div class="product-overlay">
                                <button class="add-btn-featured" @onclick="() => AgregarAlCarrito(producto.Id)" disabled="@procesandoCarrito">
                                    <i class="bi bi-cart-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-info">
                            <h5>@producto.Nombre</h5>
                            <p class="price">$@producto.Precio.ToString("F2")</p>
                        </div>
                    </div>
                }
            }
            else
            {

                <div class="product-card">
                    <div class="product-image">
                        @{
                            var product1Image = ObtenerImagenSitio("product-1");
                            var product1Config = ObtenerConfiguracionImagen("product-1");
                        }
                        @if (!string.IsNullOrEmpty(product1Image))
                        {
                            <img src="@product1Image"
                                 alt="Producto destacado 1"
                                 class="img-fluid"
                                 style="@(product1Config?.GenerarEstilosCSS() ?? "object-fit: cover;")" />
                        }
                        else if (product1Config?.OcultarFondo != true)
                        {
                            <span class="image-ref">[IMAGEN: Producto 1 - product-1.jpg]</span>
                        }
                        <div class="product-overlay">
                            <button class="add-btn-featured" @onclick="() => AgregarProductoDestacado(1)" disabled="@procesandoCarrito">
                                <i class="bi bi-cart-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="product-card">
                    <div class="product-image">
                        @{
                            var product2Image = ObtenerImagenSitio("product-2");
                            var product2Config = ObtenerConfiguracionImagen("product-2");
                        }
                        @if (!string.IsNullOrEmpty(product2Image))
                        {
                            <img src="@product2Image"
                                 alt="Producto destacado 2"
                                 class="img-fluid"
                                 style="@(product2Config?.GenerarEstilosCSS() ?? "object-fit: cover;")" />
                        }
                        else if (product2Config?.OcultarFondo != true)
                        {
                            <span class="image-ref">[IMAGEN: Producto 2 - product-2.jpg]</span>
                        }
                        <div class="product-overlay">
                            <button class="add-btn-featured" @onclick="() => AgregarProductoDestacado(2)" disabled="@procesandoCarrito">
                                <i class="bi bi-cart-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="product-card">
                    <div class="product-image">
                        @{
                            var product3Image = ObtenerImagenSitio("product-3");
                            var product3Config = ObtenerConfiguracionImagen("product-3");
                        }
                        @if (!string.IsNullOrEmpty(product3Image))
                        {
                            <img src="@product3Image"
                                 alt="Producto destacado 3"
                                 class="img-fluid"
                                 style="@(product3Config?.GenerarEstilosCSS() ?? "object-fit: cover;")" />
                        }
                        else if (product3Config?.OcultarFondo != true)
                        {
                            <span class="image-ref">[IMAGEN: Producto 3 - product-3.jpg]</span>
                        }
                        <div class="product-overlay">
                            <button class="add-btn-featured" @onclick="() => AgregarProductoDestacado(3)" disabled="@procesandoCarrito">
                                <i class="bi bi-cart-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </section>

    <section class="about-section">
        <div class="about-content">
            <div class="about-text">
                <h3 class="about-title">Sobre Nosotros</h3>
                <p class="about-description">
                    Transformando la experiencia de escritura desde 2022, creando conexiones perfectas entre tecnología y creatividad.
                </p>
                <a href="/about" class="learn-more">Saber mas</a>
            </div>
            <div class="about-image">
                @{
                    var aboutImage = ObtenerImagenSitio("about-image");
                    var aboutConfig = ObtenerConfiguracionImagen("about-image");
                }
                @if (!string.IsNullOrEmpty(aboutImage))
                {
                    <img src="@aboutImage"
                         alt="Setup gaming"
                         class="img-fluid"
                         style="@(aboutConfig?.GenerarEstilosCSS() ?? "object-fit: cover;")" />
                }
                else if (aboutConfig?.OcultarFondo != true)
                {
                    <span class="image-ref">[IMAGEN: Setup gaming - about-image.jpg]</span>
                }
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="footer-links">
            <a href="#" class="footer-link">About Us</a>
            <a href="#" class="footer-link">Contact Us</a>
            <a href="#" class="footer-link">Services</a>
            <a href="#" class="footer-link">Privacy Policy</a>
            <a href="#" class="footer-link">Terms and Conditions</a>
        </div>
    </footer>
</div>

@if (mostrarToast)
{
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div class="toast show" role="alert">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong class="me-auto">Carrito</strong>
                <button type="button" class="btn-close" @onclick="() => mostrarToast = false"></button>
            </div>
            <div class="toast-body">
                @mensajeToast
            </div>
        </div>
    </div>
}

@code {
    private List<Producto> productos = new();
    private List<Producto> productosDestacados = new();
    private List<Producto> productosCarousel = new();
    private Dictionary<string, ImagenSitio> imagenesSitio = new();
    private bool procesandoCarrito = false;
    private bool mostrarToast = false;
    private string mensajeToast = "";

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("Iniciando OnInitializedAsync...");

        await CargarProductos();
        await CargarProductosDestacados();
        await CargarProductosCarousel();
        await CargarImagenesSitio();

        Console.WriteLine("Finalizando OnInitializedAsync...");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine("Primer render completado");


            await Task.Delay(300);

            try
            {

                var result = await JSRuntime.InvokeAsync<bool>("initializeHeroCarousel");

                if (result)
                {
                    Console.WriteLine("Carousel inicializado exitosamente");


                    await JSRuntime.InvokeVoidAsync("observeCarouselChanges");
                }
                else
                {
                    Console.WriteLine("Fallo en la inicialización del carousel");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error inicializando carousel: {ex.Message}");


                await Task.Delay(1000);
                try
                {
                    await JSRuntime.InvokeVoidAsync("reinitializeComponents");
                    Console.WriteLine("Componentes reinicializados en segundo intento");
                }
                catch (Exception ex2)
                {
                    Console.WriteLine($"Error en reinicialización: {ex2.Message}");
                }
            }
        }
    }

    private async Task CargarProductos()
    {
        try
        {
            Console.WriteLine("Iniciando carga de productos...");
            await using var contexto = await DbContextFactory.CreateDbContextAsync();
            Console.WriteLine("Contexto creado exitosamente");

            var todosLosProductos = await contexto.Productos.ToListAsync();
            Console.WriteLine($"Total de productos en BD: {todosLosProductos.Count}");

            productos = await contexto.Productos
                .Where(p => p.Stock > 0)
                .OrderBy(p => p.Nombre)
                .ToListAsync();

            Console.WriteLine($"Productos con stock > 0: {productos.Count}");

            foreach (var p in productos.Take(3))
            {
                Console.WriteLine($"Producto: {p.Nombre}, Stock: {p.Stock}, Precio: {p.Precio}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando productos: {ex.Message}");
            Console.WriteLine($"StackTrace: {ex.StackTrace}");
            productos = new List<Producto>();
        }
    }

    private async Task CargarProductosDestacados()
    {
        try
        {
            Console.WriteLine("Cargando productos destacados...");
            await using var contexto = await DbContextFactory.CreateDbContextAsync();
            productosDestacados = await contexto.Productos
                .Where(p => p.EsDestacado && p.Stock > 0)
                .OrderBy(p => p.Nombre)
                .Take(6)
                .ToListAsync();

            Console.WriteLine($"Productos destacados cargados: {productosDestacados.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando productos destacados: {ex.Message}");
            productosDestacados = new List<Producto>();
        }
    }

    private async Task CargarProductosCarousel()
    {
        try
        {
            Console.WriteLine("Cargando productos del carousel...");
            await using var contexto = await DbContextFactory.CreateDbContextAsync();
            productosCarousel = await contexto.Productos
                .Where(p => p.Stock > 0 && !string.IsNullOrEmpty(p.ImagenUrl))
                .OrderByDescending(p => p.EsDestacado)
                .ThenBy(p => p.Id)
                .Take(5)
                .ToListAsync();

            Console.WriteLine($"Productos del carousel cargados: {productosCarousel.Count}");

            StateHasChanged();

            _ = Task.Run(async () =>
            {
                await Task.Delay(300);
                await InvokeAsync(async () =>
                {
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("reinitializeComponents");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error reinicializando carousel: {ex.Message}");
                    }
                });
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando productos del carousel: {ex.Message}");
            productosCarousel = new List<Producto>();
        }
    }

    private async Task CargarImagenesSitio()
    {
        try
        {
            await using var contexto = await DbContextFactory.CreateDbContextAsync();
            var imagenes = await contexto.ImagenesSitio
                .Where(i => i.Activa && i.ImagenData != null)
                .ToListAsync();

            imagenesSitio = imagenes.ToDictionary(i => i.Clave, i => i);
            Console.WriteLine($"Imágenes del sitio cargadas: {imagenesSitio.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando imágenes del sitio: {ex.Message}");
            imagenesSitio = new Dictionary<string, ImagenSitio>();
        }
    }

    private string ObtenerImagenSitio(string clave)
    {
        if (imagenesSitio.TryGetValue(clave, out var imagen) &&
            imagen.ImagenData != null && imagen.ImagenData.Length > 0)
        {
            var base64 = Convert.ToBase64String(imagen.ImagenData);
            return $"data:{imagen.TipoImagen};base64,{base64}";
        }
        return string.Empty;
    }

    private ImagenSitio? ObtenerConfiguracionImagen(string clave)
    {
        if (imagenesSitio.TryGetValue(clave, out var imagen))
        {
            return imagen;
        }
        return null;
    }

    private async Task AgregarAlCarrito(int productoId)
    {
        if (procesandoCarrito) return;

        try
        {
            procesandoCarrito = true;

            await using var contexto = await DbContextFactory.CreateDbContextAsync();
            var producto = await contexto.Productos
                .FirstOrDefaultAsync(p => p.Id == productoId);

            if (producto != null)
            {
                await CartService.AddToCartAsync(producto.Id, 1);

                mensajeToast = $"'{producto.Nombre}' agregado al carrito";
                mostrarToast = true;

                _ = Task.Delay(3000).ContinueWith(_ => InvokeAsync(() =>
                {
                    mostrarToast = false;
                    StateHasChanged();
                }));
            }
            else
            {
                mensajeToast = "Producto no encontrado";
                mostrarToast = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error agregando al carrito: {ex.Message}");
            mensajeToast = $"Error: {ex.Message}";
            mostrarToast = true;
        }
        finally
        {
            procesandoCarrito = false;
            StateHasChanged();
        }
    }

    private async Task AgregarProductoDestacado(int productoId)
    {
        if (procesandoCarrito) return;

        try
        {
            procesandoCarrito = true;

            var productosDestacadosPorDefecto = new Dictionary<int, string>
            {
                { 1, "Teclado RGB Gaming Pro" },
                { 2, "Tema Cyberpunk 2077" },
                { 3, "Teclado Mecánico Elite" }
            };

            await CartService.AddToCartAsync(productoId, 1);

            var nombreProducto = productosDestacadosPorDefecto.ContainsKey(productoId)
                ? productosDestacadosPorDefecto[productoId]
                : "Producto destacado";

            mensajeToast = $"'{nombreProducto}' agregado al carrito";
            mostrarToast = true;

            _ = Task.Delay(3000).ContinueWith(_ => InvokeAsync(() =>
            {
                mostrarToast = false;
                StateHasChanged();
            }));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error agregando producto destacado al carrito: {ex.Message}");
            mensajeToast = $"Error: {ex.Message}";
            mostrarToast = true;
        }
        finally
        {
            procesandoCarrito = false;
            StateHasChanged();
        }
    }
}